# HTTP server configuration
server {
    listen 80;
    server_name dgdg.o-r.kr;
    # server_name dgdg.o-r.kr;
    root /usr/share/nginx/html;
    index index.html index.htm;
    # client_max_body_size 10M;

    location /.well-known/acme-challenge/ {
        allow all;
        # root /usr/share/nginx/html;
        autoindex on;
        
    }

    location / {     
        try_files $uri $uri/ /index.html;
        # return 301 https://deukgeun.site:30115$request_uri;
        return 301 https://dgdg.o-r.kr:30115$request_uri;
        # return 301 https://dgdg.o-r.kr$request_uri;
    }

    location /api/ {
        proxy_pass http://223.130.157.92:30000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket proxy configuration
    location /ws {
        proxy_pass http://223.130.157.92:30000/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Origin "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    error_page 404 /index.html;
    location = /index.html {
        internal;
    }
}

# HTTPS server configuration (commented out initially)
# Uncomment after obtaining SSL certificates
server {
   listen 30115 ssl;
#  listen 443 ssl;
   server_name dgdg.o-r.kr;
#    server_name deukgeun.site;
   client_max_body_size 10M;
   root /usr/share/nginx/html;
   index index.html index.htm;

   ssl_certificate /etc/letsencrypt/live/dgdg.o-r.kr/fullchain.pem;
   ssl_certificate_key /etc/letsencrypt/live/dgdg.o-r.kr/privkey.pem;

   location / {
       try_files $uri $uri/ /index.html;
   }

   location /api/ {
       proxy_pass http://223.130.157.92:30000;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
   }

   # WebSocket proxy configuration
   location /ws {
       proxy_pass http://223.130.157.92:30000/ws;
       proxy_http_version 1.1;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection "upgrade";
       proxy_set_header Origin "";
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
   }

   error_page 404 /index.html;
   location = /index.html {
       internal;
   }
}